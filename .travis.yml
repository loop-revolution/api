language: rust
addons:
  apt:
    packages:
      - libssl-dev
      - libpq-dev
cache: cargo
rust:
  - nightly
services:
  - postgresql
before_script:
  - psql -c 'create database travis_ci_test;' -U postgres
  - psql -c "CREATE USER testing WITH PASSWORD 'password';" -U postgres
  - cargo install cargo-tarpaulin
  - cargo install diesel_cli --no-default-features --features "postgres"
  - cd block-tools && diesel setup && diesel migration run && cd ..

script:
  - cargo tarpaulin -v --out Xml

before_cache:
  # Delete loose files in the debug directory
  - find ./target/debug -maxdepth 1 -type f -delete
  # Delete the test and benchmark executables. Finding these all might take some
  # experimentation.
  - rm -rf ./target/debug/deps/criterion*
  - rm -rf ./target/debug/deps/bench*
  # Delete the associated metadata files for those executables
  - rm -rf ./target/debug/.fingerprint/criterion*
  - rm -rf ./target/debug/.fingerprint/bench*
  # Note that all of the above need to be repeated for `release/` instead of
  # `debug/` if your build script builds artifacts in release mode.
  # This is just more metadata
  - rm -f  ./target/.rustc_info.json
  # Also delete the saved benchmark data from the test benchmarks. If you
  # have Criterion.rs benchmarks, you'll probably want to do this as well, or set
  # the CRITERION_HOME environment variable to move that data out of the
  # `target/` directory.
  - rm -rf ./target/criterion
  # Also delete cargo's registry index. This is updated on every build, but it's
  # way cheaper to re-download than the whole cache is.
  - rm -rf ~/.cargo/registry/index/

after_success: |
  bash <(curl -s https://codecov.io/bash)
